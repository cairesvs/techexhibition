<html>
<head>
<style type="text/css" media="screen">
	.agenda{
		font-family:Arial;
		left:260px;
		position:absolute;
		top:400px;
		color:white;
    width:250px;
    height:250px;
	}
	
</style>
<script type="text/javascript" charset="utf-8" src="http://ajax.googleapis.com/ajax/libs/jquery/1/jquery.min.js"></script>
</head>
<body style="overflow:hidden; background: black">
<canvas id="canvasElement" width="100" height="100"></canvas>
<script type="text/javascript" charset="utf-8">

function HexToR(h) {return parseInt((cutHex(h)).substring(0,2),16)}
function HexToG(h) {return parseInt((cutHex(h)).substring(2,4),16)}
function HexToB(h) {return parseInt((cutHex(h)).substring(4,6),16)}
function cutHex(h) {return (h.charAt(0)=="#") ? h.substring(1,7):h}
var html = '';
$.ajax({
  url: '/agenda',
  async: false,
  success: function(data){
    html = data;
  }
});
eventos = [];
$(html).find("div").each(function(){
    if($(this).attr("class").match("evento*")){
      eventos.push(this);   
    }
});
	var count = 0;
	var particles = [];
				for( var i = 0; i < eventos.length; i++ ) {
					var tamanhoJanela = window.innerWidth;
					var margemHorizontal = 200;
          var minX = margemHorizontal;
					var maxX = tamanhoJanela - margemHorizontal;
					var espacamento = (maxX - minX)/eventos.length;
					var x = minX + (i * espacamento);
					var y = 200;		
					particles.push( { 
						id: i,
            estado: $(eventos[i]).find(".info").find("small").html(), 
						x: x , 
						y: y,
						xOriginal: x,
						yOriginal: y,
						vx:0, 
						vy:0,
						nome: $(eventos[i]).find(".info").find("#evento").find("a").html(),
						data: $(eventos[i]).find(".data").find("p").html() + "/" + $(eventos[i]).find(".data").find("small").html(),
						history: [],
						size: eventos.length - i,
						color: "255," + i * 5  + ",0"
					} );
				}
				
				var mouse = { x: 0, y: 0 };

				var canvas = document.getElementById('canvasElement');
				canvas.width = window.innerWidth;
				canvas.height = window.innerHeight;

				if (canvas && canvas.getContext) {
					var context = canvas.getContext('2d');

					Initialize();
				}

				function Initialize() {
					canvas.addEventListener('mousemove', MouseMove, false);
					window.addEventListener('resize', ResizeCanvas, false);
					setInterval( TimeUpdate, 100 );
					context.beginPath();

					ResizeCanvas();
				}
				
				function TimeUpdate(e) {

					count++;
					context.clearRect(0, 0, window.innerWidth, window.innerHeight);

					for( var i = 0; i < particles.length; i++ ) {

						particles[i].vx = Math.sin( count + i * 3);
						particles[i].vy =  Math.sin(count + i * 5) ;

						context.beginPath();
					
						var distance = DistanceBetween( mouse, particles[i] );
						var distanceFactor;
						if(distance <= 100 )
						{
							var distanceFactor = Math.max( Math.min(500/distance, 100), 1);
						} else {
							distanceFactor = 1;
							
						}

						if( distance > 60 && distance <= 100) {
							if ( particles[i + 1] ) {
								particles[i + 1].x += particles[i + 1].vx + 5;
							} 
							if ( particles[i - 1] ) {
								particles[i - 1].x += particles[i - 1].vx - 5;
							}						
						} else  { 
							particles[i].x = particles[i].xOriginal;
						}
						
						particles[i].y += particles[i].vy;

            var carinha = -distanceFactor*0.3/10;
            context.fillStyle = "rgba("+ particles[i].color+ "," +(0.7 + carinha)+")";

						context.beginPath();
            var maxSize = particles[i].size + distanceFactor * 7;
            
            context.arc( 
								particles[i].x,
								particles[i].y,
								maxSize,
								0,
								Math.PI * 2 ,
								false);
					
						context.closePath();
						context.fill();

						if(distanceFactor >= 10){
								$('body').append("<div class='agenda " + particles[i].id + "'></div>");
								$(".agenda").each(function(){
										if(!$(this).attr("class").match("" + particles[i].id)){			
											$(this).removeClass().addClass("agenda " + particles[i].id);
			                $(this).html("<h2>"+ particles[i].nome + "</h2><p>" + particles[i].data + "</p>");
			                $(this).attr("style", "top:" + ( particles[i].y - 125)  + "px;left:" + (particles[i].x - 125) + "px;display: block;");
			                this.addEventListener("mousemove", MouseCalibrate(particles[i]), false);
										}
								});
						}else{
							$(".agenda").each(function(){
								if($(this).attr("class").match("" + particles[i].id)){
									$(this).remove();
								}
							});
						}
					}
				}

				function MouseMove(e) {
						mouse.x = e.layerX;
						mouse.y = e.layerY;
				}

				
				function MouseCalibrate(particle){
					return function(e){
						mouse.x = ( e.layerX + particle.x ) - 125;
						mouse.y = ( e.layerY+ particle.y ) - 125;
					}
				}

				function ResizeCanvas(e) {
					canvas.width = window.innerWidth;
					canvas.height = window.innerHeight;
				}

				function DistanceBetween(mousePointer,particle) {
					var dx = particle.x-mousePointer.x;
					var dy = particle.y-mousePointer.y;
					return Math.sqrt(dx*dx + dy*dy);
				}
</script>
</body>
</html>
